var FacebookPlayer=Backbone.Model.extend({STATUS_LOGGED_IN:"connected",FB_SCOPE:"email, user_groups, user_events, user_likes, user_photos, user_relationships, user_status, user_videos, read_friendlists, read_stream, friends_about_me",FB_ME_URL:"/me?fields=id,name,gender,locale",FB_FRIENDS_URL:"/me/friends?fields=id,name",FB_FRIENDLIST_URL:"/me/friendlists/?fields=members.fields(id),id,name",FB_PICTURES_URL:"/me/albums?fields=id,name,photos.fields(id,name,source,height,width,from)",FB_FEED_URL:"/me/feed",FB_GRAPH_BASE:"https://graph.facebook.com/",FB_IMAGE_SUFFIX:"/picture?type=square",DELAY_INIT_EVENT:2500,loggedin:undefined,_friends:undefined,_friendlists:undefined,_pictures:undefined,_posts:undefined,defaults:{id:undefined,name:undefined,locale:undefined,picture:undefined,gender:undefined},initialize:function(){console.log("[FacebookPlayer] New FacebookPlayer");FB.Event.subscribe("auth.authResponseChange",_.bind(this._authResponseChangeCb,this));FB.init({appId:"508385819190108",status:!0,cookie:!0});this._initEventFired=!1;this.set("results",new TestResultCollection);setTimeout(_.bind(function(){if(!this._initEventFired){this.loggedin=!1;this.trigger("login:change",[this.loggedin])}},this),this.DELAY_INIT_EVENT)},login:function(){console.log("[FacebookPlayer] Loggin player in");this.trigger("login:start");FB.login(_.bind(function(){this._authResponseChangeCb();this.trigger("login:done")},this),{scope:this.FB_SCOPE})},logout:function(){console.log("[FacebookPlayer] Loggin player out");this.trigger("login:start");FB.logout(_.bind(function(){this._authResponseChangeCb();this.trigger("login:done")},this))},_authResponseChangeCb:function(e){var t=this.loggedin;if(e===undefined||!e.status)return;e.status==this.STATUS_LOGGED_IN?this.loggedin=!0:this.loggedin=!1;console.log("[FacebookPlayer] old: "+t+" new: "+this.loggedin);this.loggedin&&this.get("name")===undefined&&this._loadProfile();e.status==this.STATUS_LOGGED_IN!=t&&this.trigger("login:change",[this.loggedin]);this._initEventFired=!0},_loadProfile:function(){FB.api(this.FB_ME_URL,_.bind(function(e){console.log("[FacebookPlayer] ",e);this.set("name",e.name),this.set("id",e.id),this.set("locale",e.locale);this.set("gender",e.gender);this.set("picture",this.FB_GRAPH_BASE+e.id+this.FB_IMAGE_SUFFIX);this.trigger("profile:loaded")},this))},getFriends:function(){if(this._friends===undefined){this._loadFriends();return undefined}return this._friends},_loadFriends:function(){this.trigger("friends:start");FB.api(this.FB_FRIENDS_URL,_.bind(function(e){if(!e.data){this.trigger("friends:error");console.error("[FacebookPlayer] Error loading friends, response was: ",e);return}this._friends=new FacebookUserCollection(_.map(e.data,function(e){try{return new FacebookUser({name:e.name,id:e.id})}catch(t){console.error("[FacebookPlayer] Unable to parse friend: "+t.message)}}));console.log("[FacebookPlayer] Friends of "+this.get("id")+": ",this._friends);this.trigger("friends:finished")},this))},getForeigners:function(){if(this._foreigners===undefined){this._loadForeigners();return undefined}return this._foreigners},_loadForeigners:function(){var e=FacebookRandomCollector.getInstance();this.trigger("random:start");e.on("frc:done",_.bind(function(e){this._foreigners=e;console.log("[FacebookPlayer] Foreigners of "+this.get("id")+": ",this._foreigners);this.trigger("random:finished")},this));e.collect()},getFriendLists:function(){if(this._friendlists===undefined){this._loadFriendLists();return undefined}return this._friendlists},_loadFriendLists:function(){this.trigger("friendlist:start");if(this.getFriends()===undefined){this.trigger("friendlist:error");console.log("[FacebookPlayer] Error loading friendlist, friends not loaded");return}FB.api(this.FB_FRIENDLIST_URL,_.bind(function(e){if(!e.data){this.trigger("friendlist:error");console.error("[FacebookPlayer] Error loading friendlist, response was: ",e);return}if(e.data.length===0){console.warn("[FacebookPlayer] Users has no lists");this.trigger("friendlist:finished")}this._friendlists=new FacebookListCollection(_.map(e.data,_.bind(function(e){var t=e.id,n=new FacebookList({id:e.id,name:e.name,type:e.list_type,members:new FacebookUserCollection});e.members&&e.members.data&&_.each(e.members.data,_.bind(function(e){n.get("members").add(this._friends.getByUid(e.id))},this));return n},this)));this.trigger("friendlist:finished");console.log("[FacebookPlayer] Friendlists of "+this.get("id")+": ",this._friendlists)},this))},getPictures:function(){if(this._pictures===undefined){this._loadPictures();return undefined}return this._pictures},_loadPictures:function(){this.trigger("pictures:start");FB.api(this.FB_PICTURES_URL,_.bind(function(e){if(!e.data){this.trigger("pictures:error");console.error("[FacebookPlayer] Error loading pictures, response was: ",e);return}if(e.data.length===0){console.warn("[FacebookPlayer] Users has no albums");this.trigger("pictures:finished")}this._pictures=new FacebookPictureCollection;var t=0;_.each(e.data,_.bind(function(e){if(e.photos){t+=e.photos.data.length;this._pictures.add(_.map(e.photos.data,_.bind(function(e){try{var n=new FacebookPicture({id:e.id,name:e.name,source:e.source,width:e.width,height:e.height}),r=!1;n.on("privacy",_.bind(function(){if(--t===0){console.log("[FacebookPlayer] "+this._pictures.length+" Pictures of "+this.get("id")+": ",this._pictures);this.trigger("pictures:finished")}},this));n.on("privacy-error",_.bind(function(){if(--t===0){console.log("[FacebookPlayer] "+this._pictures.length+" Pictures of "+this.get("id")+": ",this._pictures);this.trigger("pictures:finished")}r=!0},this));if(!r)return n}catch(i){console.error("[FacebookPlayer] Error creating FacebookPicture: ",i)}},this)))}},this))},this))},getPosts:function(){if(this._posts===undefined){this._loadPosts();return undefined}return this._posts},_loadPosts:function(){this.trigger("posts:start");if(this.getFriends()===undefined){this.trigger("posts:error");console.log("[FacebookPlayer] Error loading posts, friends not loaded");return}FB.api(this.FB_FEED_URL,_.bind(function(e){if(!e.data){this.trigger("posts:error");console.error("[FacebookPlayer] Error loading psots, response was: ",e);return}this._posts=new FacebookPostCollection(_.filter(e.data,_.bind(function(e){if(e.from.id==this.id&&e.privacy!==undefined)return new FacebookPost({message:e.message,id:e.id,privacy:e.privacy})},this)));console.log("[FacebookPlayer] Posts of "+this.get("id")+": ",this._posts);this.trigger("posts:finished")},this))}},{getInstance:function(){this.__instance===undefined&&(this.__instance=new this);return this.__instance}});